<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Ejolie Chat</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .admin-header {
        background: linear-gradient(135deg, #1a5490, #2a7bb8);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .admin-header h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid #e0e0e0;
        background: #f9f9f9;
        overflow-x: auto;
      }

      .tab-btn {
        padding: 15px 25px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .tab-btn:hover {
        background: #f0f0f0;
      }

      .tab-btn.active {
        color: #1a5490;
        border-bottom-color: #1a5490;
        background: white;
      }

      .tab-content {
        display: none;
        padding: 30px;
        animation: fadeIn 0.3s ease;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      input[type="password"],
      input[type="text"],
      input[type="file"],
      textarea {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.3s ease;
      }

      input[type="password"]:focus,
      input[type="text"]:focus,
      input[type="file"]:focus,
      textarea:focus {
        outline: none;
        border-color: #1a5490;
      }

      textarea {
        resize: vertical;
        min-height: 100px;
      }

      button {
        background: linear-gradient(135deg, #1a5490, #2a7bb8);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      button:hover {
        box-shadow: 0 4px 12px rgba(26, 84, 144, 0.3);
        transform: translateY(-2px);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .delete-btn {
        background: #dc3545;
        padding: 8px 15px;
        font-size: 13px;
        margin: 5px 0;
      }

      .delete-btn:hover {
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
      }

      .edit-btn {
        background: #ffc107;
        color: #000;
        padding: 8px 15px;
        font-size: 13px;
        margin: 5px 0;
      }

      .edit-btn:hover {
        background: #ffb300;
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      }

      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
      }

      .section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
      }

      .section:last-child {
        border-bottom: none;
      }

      .section h3 {
        color: #1a5490;
        margin-bottom: 15px;
        font-size: 18px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .analytics-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #1a5490, #2a7bb8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-card h4 {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-card .number {
        font-size: 32px;
        font-weight: bold;
      }

      .conversations-list {
        max-height: 700px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #f9f9f9;
      }

      .conversation-item {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        background: white;
        margin: 5px;
        border-radius: 6px;
      }

      .conversation-item:last-child {
        border-bottom: none;
      }

      .conversation-item:hover {
        background: #f0f7ff;
      }

      .conversation-time {
        font-size: 12px;
        color: #999;
        margin-bottom: 8px;
      }

      .conversation-user {
        font-weight: 600;
        color: #1a5490;
        margin-bottom: 8px;
        padding: 8px;
        background: #e8f0f7;
        border-radius: 4px;
      }

      .conversation-user strong {
        display: block;
        margin-bottom: 4px;
      }

      .conversation-response {
        color: #333;
        font-size: 14px;
        line-height: 1.5;
        padding: 8px;
        background: #f5f5f5;
        border-radius: 4px;
      }

      .conversation-response strong {
        color: #1a5490;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .tag {
        background: #e8f0f7;
        color: #1a5490;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .tag .remove-tag {
        cursor: pointer;
        color: #dc3545;
        font-weight: bold;
      }

      .faq-item,
      .rule-item {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #1a5490;
      }

      .faq-item h4,
      .rule-item h4 {
        color: #1a5490;
        margin-bottom: 8px;
      }

      .faq-item p,
      .rule-item p {
        color: #666;
        font-size: 14px;
      }

      .status-output {
        background: #f0f0f0;
        padding: 15px;
        border-radius: 8px;
        font-family: monospace;
        white-space: pre-wrap;
        margin-top: 15px;
        display: none;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-header h3 {
        color: #1a5490;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        padding: 0;
        margin: 0;
      }

      .close-modal:hover {
        color: #333;
        box-shadow: none;
        transform: none;
      }

      .sync-feed-btn {
        background: linear-gradient(135deg, #17a2b8, #138496);
      }

      .sync-feed-btn:hover {
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }

        .tabs {
          flex-wrap: nowrap;
        }

        .tab-btn {
          padding: 12px 15px;
          font-size: 12px;
        }

        .admin-header h1 {
          font-size: 22px;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <h1>‚öôÔ∏è Admin Panel - Ejolie Chat</h1>
        <p>GestioneazƒÉ chatbot-ul »ôi vezi analytics</p>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('logistics')">
          üì¶ Logistics
        </button>
        <button class="tab-btn" onclick="showTab('occasions')">
          üé≠ Occasions
        </button>
        <button class="tab-btn" onclick="showTab('faq')">üí¨ FAQ</button>
        <button class="tab-btn" onclick="showTab('rules')">
          ‚öôÔ∏è Custom Rules
        </button>
        <button class="tab-btn" onclick="showTab('products')">
          üì¶ Products
        </button>
        <button class="tab-btn" onclick="showTab('analytics')">
          üìä Analytics
        </button>
      </div>

      <!-- TAB 1: LOGISTICS -->
      <div id="logistics" class="tab-content active">
        <h2>üì¶ Logistics Settings</h2>
        <p style="color: #666; margin-bottom: 20px">
          ConfigureazƒÉ informa»õiile de contact, livrare »ôi retur.
        </p>

        <div id="logisticsSuccess" class="success-message"></div>
        <div id="logisticsError" class="error-message"></div>

        <div class="section">
          <h3>üìû Contact</h3>
          <div class="grid">
            <div class="form-group">
              <label>Email</label>
              <input
                type="text"
                id="contactEmail"
                placeholder="contact@ejolie.ro"
              />
            </div>
            <div class="form-group">
              <label>Telefon</label>
              <input
                type="text"
                id="contactPhone"
                placeholder="+40 XXX XXX XXX"
              />
            </div>
            <div class="form-group">
              <label>Program</label>
              <input
                type="text"
                id="contactHours"
                placeholder="Luni - Vineri, 09:00 - 18:00"
              />
            </div>
          </div>
        </div>

        <div class="section">
          <h3>üöö Livrare</h3>
          <div class="grid">
            <div class="form-group">
              <label>Timp livrare</label>
              <input type="text" id="shippingDays" placeholder="3-5 zile" />
            </div>
            <div class="form-group">
              <label>Cost standard (RON)</label>
              <input type="text" id="shippingCost" placeholder="25" />
            </div>
            <div class="form-group">
              <label>Prag livrare gratuitƒÉ (RON)</label>
              <input type="text" id="freeShippingThreshold" placeholder="200" />
            </div>
          </div>
        </div>

        <div class="section">
          <h3>‚Ü©Ô∏è PoliticƒÉ Retur</h3>
          <div class="form-group">
            <label>Detalii retur</label>
            <textarea
              id="returnPolicy"
              rows="4"
              placeholder="Retur gratuit √Æn 30 de zile..."
            ></textarea>
          </div>
        </div>

        <div class="form-group">
          <label>üîê ParolƒÉ Admin</label>
          <input type="password" id="adminPassword1" placeholder="Parola" />
        </div>

        <button onclick="saveLogistics()">üíæ SalveazƒÉ Logistics</button>
      </div>

      <!-- TAB 2: OCCASIONS -->
      <div id="occasions" class="tab-content">
        <h2>üé≠ Occasions Management</h2>
        <p style="color: #666; margin-bottom: 20px">
          AdaugƒÉ ocazii pentru recomandƒÉri (nuntƒÉ, botez, etc.)
        </p>

        <div id="occasionsSuccess" class="success-message"></div>
        <div id="occasionsError" class="error-message"></div>

        <div class="section">
          <h3>Ocazii existente</h3>
          <div id="occasionsList" class="tag-list">
            <!-- Se populeazƒÉ din JS -->
          </div>
        </div>

        <div class="section">
          <h3>‚ûï AdaugƒÉ ocazie nouƒÉ</h3>
          <div class="grid">
            <div class="form-group">
              <label>Nume ocazie</label>
              <input type="text" id="occasionName" placeholder="ex: NuntƒÉ" />
            </div>
            <div class="form-group">
              <label>Descriere</label>
              <input
                type="text"
                id="occasionDesc"
                placeholder="ex: Rochii elegante pentru nuntƒÉ"
              />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>üîê ParolƒÉ Admin</label>
          <input type="password" id="adminPassword2" placeholder="Parola" />
        </div>

        <button onclick="addOccasion()">‚ûï AdaugƒÉ Ocazie</button>
      </div>

      <!-- TAB 3: FAQ -->
      <div id="faq" class="tab-content">
        <h2>üí¨ FAQ Management</h2>
        <p style="color: #666; margin-bottom: 20px">
          GestioneazƒÉ √ÆntrebƒÉrile frecvente »ôi rƒÉspunsurile.
        </p>

        <div id="faqSuccess" class="success-message"></div>
        <div id="faqError" class="error-message"></div>

        <div class="section">
          <h3>FAQ-uri existente</h3>
          <div id="faqList">
            <!-- Se populeazƒÉ din JS -->
          </div>
        </div>

        <div class="section">
          <h3>‚ûï AdaugƒÉ FAQ nou</h3>
          <div class="form-group">
            <label>√éntrebare</label>
            <input
              type="text"
              id="faqQuestion"
              placeholder="ex: C√¢t dureazƒÉ livrarea?"
            />
          </div>
          <div class="form-group">
            <label>RƒÉspuns</label>
            <textarea
              id="faqAnswer"
              rows="3"
              placeholder="ex: Livrarea dureazƒÉ 3-5 zile lucrƒÉtoare..."
            ></textarea>
          </div>
        </div>

        <div class="form-group">
          <label>üîê ParolƒÉ Admin</label>
          <input type="password" id="adminPassword3" placeholder="Parola" />
        </div>

        <button onclick="addFAQ()">‚ûï AdaugƒÉ FAQ</button>
      </div>

      <!-- TAB 4: CUSTOM RULES -->
      <div id="rules" class="tab-content">
        <h2>‚öôÔ∏è Custom Rules</h2>
        <p style="color: #666; margin-bottom: 20px">
          AdaugƒÉ reguli personalizate pentru chatbot.
        </p>

        <div id="rulesSuccess" class="success-message"></div>
        <div id="rulesError" class="error-message"></div>

        <div class="section">
          <h3>Reguli existente</h3>
          <div id="rulesList">
            <!-- Se populeazƒÉ din JS -->
          </div>
        </div>

        <div class="section">
          <h3>‚ûï AdaugƒÉ regulƒÉ nouƒÉ</h3>
          <div class="form-group">
            <label>Titlu</label>
            <input
              type="text"
              id="ruleTitle"
              placeholder="ex: Salut personalizat"
            />
          </div>
          <div class="form-group">
            <label>Tip</label>
            <select
              id="ruleType"
              style="
                width: 100%;
                padding: 10px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
              "
            >
              <option value="greeting">Greeting</option>
              <option value="restriction">Restriction</option>
              <option value="promotion">Promotion</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="form-group">
            <label>Con»õinut</label>
            <textarea
              id="ruleContent"
              rows="3"
              placeholder="ex: √éntotdeauna salutƒÉ cu 'BunƒÉ ziua!'"
            ></textarea>
          </div>
        </div>

        <div class="form-group">
          <label>üîê ParolƒÉ Admin</label>
          <input type="password" id="adminPassword4" placeholder="Parola" />
        </div>

        <button onclick="addCustomRule()">‚ûï AdaugƒÉ RegulƒÉ</button>
      </div>

      <!-- TAB 5: PRODUCTS -->
      <div id="products" class="tab-content">
        <h2>üì¶ Products Management</h2>
        <p style="color: #666; margin-bottom: 20px">
          SincronizeazƒÉ produsele automat din feed sau uploadeazƒÉ CSV manual.
        </p>

        <div id="uploadSuccessMsg" class="success-message"></div>
        <div id="uploadErrorMsg" class="error-message"></div>

        <div class="section">
          <h3>üìä Status Produse</h3>
          <div class="analytics-stats">
            <div class="stat-card">
              <h4>Total Produse</h4>
              <div class="number" id="totalProducts">0</div>
            </div>
            <div class="stat-card">
              <h4>Ultima Actualizare</h4>
              <div class="number" id="lastUpdated" style="font-size: 16px">
                -
              </div>
            </div>
            <div class="stat-card">
              <h4>SursƒÉ Date</h4>
              <div class="number" id="dataSource" style="font-size: 16px">
                -
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>üåê Sync Automat din Feed</h3>
          <p style="color: #666; margin-bottom: 15px; font-size: 14px">
            DescarcƒÉ automat toate produsele de pe ejolie.ro (din feed-ul
            Facebook).
            <br />Nu mai trebuie sƒÉ uploadezi CSV manual!
          </p>
          <div class="form-group">
            <label>üîê ParolƒÉ Admin</label>
            <input type="password" id="productsPassword" placeholder="Parola" />
          </div>
          <button onclick="syncFromFeed()" class="sync-feed-btn">
            üåê Sync din Feed (Automat)
          </button>
          <button onclick="checkProductsStatus()" style="background: #28a745">
            üîç Check Status
          </button>
        </div>

        <div class="section">
          <h3>üì§ Upload CSV Manual (Op»õional)</h3>
          <p style="color: #666; margin-bottom: 15px; font-size: 14px">
            Alternativ, po»õi uploada un fi»ôier CSV manual.
            <br />Format:
            <code
              >Nume, Pret vanzare (cu promotie), Descriere, Stoc numeric, Link
              produs</code
            >
          </p>
          <div class="form-group">
            <label>SelecteazƒÉ fi»ôier CSV</label>
            <input type="file" id="productsFile" accept=".csv" />
          </div>
          <button onclick="uploadProducts()">üì§ Upload CSV</button>
        </div>

        <div id="statusOutput" class="status-output"></div>
      </div>

      <!-- TAB 6: ANALYTICS -->
<div id="analytics" class="tab-content">
  <h2>üìä Analytics & Conversa»õii</h2>
  <p style="color: #666; margin-bottom: 20px">
    VizualizeazƒÉ toate conversa»õiile cu clien»õii.
  </p>

  <!-- Header with Stats and Password -->
  <div class="analytics-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 20px; flex-wrap: wrap;">
    <!-- Stats Cards -->
    <div class="analytics-stats" style="display: flex; gap: 15px;">
      <div class="stat-card" style="background: #2196F3; color: white; padding: 15px 25px; border-radius: 8px; min-width: 180px; text-align: center;">
        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">Total Conversa»õii</h4>
        <div class="number" id="totalConversations" style="font-size: 32px; font-weight: bold; margin-top: 8px;">0</div>
      </div>
      <div class="stat-card" style="background: #4CAF50; color: white; padding: 15px 25px; border-radius: 8px; min-width: 180px; text-align: center;">
        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">Total Mesaje</h4>
        <div class="number" id="totalMessages" style="font-size: 32px; font-weight: bold; margin-top: 8px;">0</div>
      </div>
      <div class="stat-card" style="background: #FF9800; color: white; padding: 15px 25px; border-radius: 8px; min-width: 180px; text-align: center;">
        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">On-Topic %</h4>
        <div class="number" id="onTopicPercentage" style="font-size: 32px; font-weight: bold; margin-top: 8px;">0%</div>
      </div>
    </div>

    <!-- Password & Buttons -->
    <div style="display: flex; gap: 10px; align-items: center;">
      <input
        type="password"
        id="analyticsPassword"
        placeholder="ParolƒÉ admin"
        style="
          padding: 10px 15px;
          border-radius: 6px;
          border: 2px solid #e0e0e0;
          font-size: 14px;
          width: 180px;
        "
      />
      <button onclick="loadConversations()" style="
        padding: 10px 20px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      ">üîÑ Re√ÆncarcƒÉ</button>
      <button onclick="exportConversationsCSV()" style="
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      ">üì• Export CSV</button>
    </div>
  </div>

  <!-- Search/Filter -->
  <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
    <input
      type="text"
      id="searchKeyword"
      placeholder="Cauta dupƒÉ keyword..."
      style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; flex: 1; min-width: 200px;"
    />
    <input
      type="date"
      id="filterDate"
      style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
    />
    <button onclick="filterConversations()" style="
      padding: 10px 20px;
      background: #FF9800;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    ">üîç FiltreazƒÉ</button>
  </div>

  <!-- Conversations Table -->
  <div class="conversations-list" id="conversationsList" style="
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  ">
    <div class="no-data" style="
      text-align: center;
      padding: 40px;
      color: #999;
    ">
      üîê Introdu parola »ôi apasƒÉ Re√ÆncarcƒÉ pentru a vedea conversa»õiile
    </div>
  </div>

  <!-- Pagination -->
  <div id="paginationControls" style="
    margin-top: 20px;
    text-align: center;
    display: none;
  ">
    <button onclick="prevPage()" style="padding: 8px 15px; margin: 5px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">‚Üê Pagina AnterioarƒÉ</button>
    <span id="pageInfo" style="margin: 0 15px; font-weight: bold;"></span>
    <button onclick="nextPage()" style="padding: 8px 15px; margin: 5px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">Pagina UrmƒÉtoare ‚Üí</button>
  </div>

  <!-- Modal for Conversation Details -->
  <div id="conversationModal" style="
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
  ">
    <div style="
      background: white;
      margin: 5% auto;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      border-radius: 10px;
      max-height: 80vh;
      overflow-y: auto;
    ">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
        <h3 id="modalTitle" style="margin: 0;">Detalii Conversa»õie</h3>
        <button onclick="closeModal()" style="
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #999;
        ">√ó</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>
</div>

<style>
  .analytics-stats {
    display: flex;
    gap: 15px;
  }

  .stat-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    min-width: 150px;
  }

  .stat-card h4 {
    margin: 0;
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
  }

  .stat-card .number {
    font-size: 28px;
    font-weight: bold;
    color: #2196F3;
    margin-top: 8px;
  }

  .conversations-table {
    width: 100%;
    border-collapse: collapse;
  }

  .conversations-table th {
    background: #f5f5f5;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #ddd;
  }

  .conversations-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
  }

  .conversations-table tr:hover {
    background: #f9f9f9;
  }

  .btn-small {
    padding: 6px 12px;
    margin: 0 4px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
  }

  .btn-view {
    background: #2196F3;
    color: white;
  }

  .btn-delete {
    background: #f44336;
    color: white;
  }

  .btn-small:hover {
    opacity: 0.8;
  }

  .message {
    padding: 10px;
    margin: 10px 0;
    border-radius: 5px;
    border-left: 4px solid #ddd;
  }

  .message.user {
    background: #e3f2fd;
    border-left-color: #2196F3;
  }

  .message.bot {
    background: #f5f5f5;
    border-left-color: #999;
  }

  .no-data {
    text-align: center;
    padding: 40px;
    color: #999;
  }
</style>

<script>
  let currentPage = 1;
  const PAGE_SIZE = 20;
  let allConversations = [];

  // Load conversations
  function loadConversations() {
    const password = document.getElementById('analyticsPassword').value;

    if (!password) {
      alert('Te rog introdu parola!');
      return;
    }

    const url = `/api/admin/analytics/conversations?password=${encodeURIComponent(password)}&limit=${PAGE_SIZE}&offset=0`;

    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (data.error) {
          alert('‚ùå ' + data.error);
          return;
        }

        allConversations = data.conversations || [];
        displayConversations();
        loadStats(password);

        if (allConversations.length === 0) {
          document.getElementById('conversationsList').innerHTML = '<div class="no-data">üì≠ Nicio conversa»õie gƒÉsitƒÉ</div>';
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('‚ùå Eroare la √ÆncƒÉrcarea conversa»õiilor');
      });
  }

  // Display conversations in table
  function displayConversations() {
    const container = document.getElementById('conversationsList');
    const password = document.getElementById('analyticsPassword').value;

    if (allConversations.length === 0) {
      container.innerHTML = '<div class="no-data">üì≠ Nicio conversa»õie gƒÉsitƒÉ</div>';
      document.getElementById('paginationControls').style.display = 'none';
      return;
    }

    let html = `
      <table class="conversations-table">
        <thead>
          <tr>
            <th>#ID</th>
            <th>Data</th>
            <th>Mesaje</th>
            <th>On-Topic</th>
            <th>Status</th>
            <th>Ac»õiuni</th>
          </tr>
        </thead>
        <tbody>
    `;

    allConversations.forEach(conv => {
      const date = new Date(conv.start_time).toLocaleDateString('ro-RO');
      const onTopic = conv.on_topic_count;
      const offTopic = conv.off_topic_count;
      const total = onTopic + offTopic;
      const percentage = total > 0 ? Math.round((onTopic / total) * 100) : 0;

      html += `
        <tr>
          <td>#${conv.id}</td>
          <td>${date}</td>
          <td>${conv.total_messages}</td>
          <td>${percentage}%</td>
          <td><span style="background: ${conv.status === 'active' ? '#4CAF50' : '#f44336'}; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px;">${conv.status}</span></td>
          <td>
            <button class="btn-small btn-view" onclick="viewConversation(${conv.id}, '${password}')">üëÅÔ∏è Vezi</button>
            <button class="btn-small btn-delete" onclick="deleteConversation(${conv.id}, '${password}')">üóëÔ∏è »òterge</button>
          </td>
        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
    `;

    container.innerHTML = html;
    document.getElementById('paginationControls').style.display = 'block';
  }

  // Load stats
function loadStats(password) {
    const url = `/api/admin/analytics/stats?password=${encodeURIComponent(password)}&days=30`;
    
    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (data.stats) {
          document.getElementById('totalConversations').textContent = (data.stats.total_conversations || 0).toLocaleString();
          document.getElementById('totalMessages').textContent = (data.stats.total_messages || 0).toLocaleString();
          document.getElementById('onTopicPercentage').textContent = (data.stats.on_topic_percentage || 0).toFixed(1) + '%';
        }
      })
      .catch(err => console.error('Stats error:', err));
}

  // View conversation details
  function viewConversation(conversationId, password) {
    const url = `/api/admin/analytics/conversation/${conversationId}?password=${encodeURIComponent(password)}`;

    fetch(url)
      .then(r => r.json())
      .then(data => {
        const modal = document.getElementById('conversationModal');
        const content = document.getElementById('modalContent');

        const conv = data.conversation;
        const messages = data.messages || [];

        let html = `
          <p><strong>Session ID:</strong> ${conv.session_id}</p>
          <p><strong>Data:</strong> ${new Date(conv.start_time).toLocaleString('ro-RO')}</p>
          <p><strong>Total Mesaje:</strong> ${conv.total_messages}</p>
          <p><strong>On-Topic:</strong> ${conv.on_topic_count} | <strong>Off-Topic:</strong> ${conv.off_topic_count}</p>
          <hr style="margin: 20px 0;">
          <h4>Conversa»õie:</h4>
        `;

        messages.forEach(msg => {
          const senderLabel = msg.sender === 'user' ? 'üë§ User' : 'ü§ñ Bot';
          const msgClass = msg.sender === 'user' ? 'user' : 'bot';
          const time = new Date(msg.timestamp).toLocaleTimeString('ro-RO');

          html += `
            <div class="message ${msgClass}">
              <strong>${senderLabel}:</strong> ${msg.message}
              <small style="display: block; margin-top: 5px; opacity: 0.7;">${time}</small>
            </div>
          `;
        });

        content.innerHTML = html;
        modal.style.display = 'block';
      })
      .catch(err => {
        console.error('Error:', err);
        alert('‚ùå Eroare la √ÆncƒÉrcarea conversa»õiei');
      });
  }

  // Close modal
  function closeModal() {
    document.getElementById('conversationModal').style.display = 'none';
  }

  // Delete conversation
  function deleteConversation(conversationId, password) {
    if (!confirm('E»ôti sigur cƒÉ vrei sƒÉ »ôtergi aceastƒÉ conversa»õie?')) return;

    const url = `/api/admin/analytics/conversation/${conversationId}?password=${encodeURIComponent(password)}`;

    fetch(url, { method: 'DELETE' })
      .then(r => r.json())
      .then(data => {
        alert('‚úÖ Conversa»õie »ôtearsƒÉ!');
        loadConversations();
      })
      .catch(err => {
        console.error('Error:', err);
        alert('‚ùå Eroare la »ôtergerea conversa»õiei');
      });
  }

  // Export to CSV
  function exportConversationsCSV() {
    const password = document.getElementById('analyticsPassword').value;

    if (!password) {
      alert('Te rog introdu parola!');
      return;
    }

    window.location.href = `/api/admin/analytics/export-csv?password=${encodeURIComponent(password)}`;
  }

  // Filter conversations
  function filterConversations() {
    // Simple client-side filter for demo
    const keyword = document.getElementById('searchKeyword').value.toLowerCase();

    if (keyword) {
      const filtered = allConversations.filter(conv =>
        JSON.stringify(conv).toLowerCase().includes(keyword)
      );
      allConversations = filtered;
      displayConversations();
    } else {
      loadConversations();
    }
  }

  // Pagination
  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      loadConversations();
    }
  }

  function nextPage() {
    currentPage++;
    loadConversations();
  }

  // Close modal on outside click
  window.onclick = function(event) {
    const modal = document.getElementById('conversationModal');
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  };
</script>

    <!-- MODAL: Edit Custom Rule -->
    <div id="editRuleModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚úèÔ∏è EditeazƒÉ RegulƒÉ</h3>
          <button class="close-modal" onclick="closeEditCustomRuleModal()">
            √ó
          </button>
        </div>
        <div class="form-group">
          <label>Titlu</label>
          <input type="text" id="editRuleTitle" />
        </div>
        <div class="form-group">
          <label>Tip</label>
          <select
            id="editRuleType"
            style="
              width: 100%;
              padding: 10px;
              border: 2px solid #e0e0e0;
              border-radius: 6px;
            "
          >
            <option value="greeting">Greeting</option>
            <option value="restriction">Restriction</option>
            <option value="promotion">Promotion</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="form-group">
          <label>Con»õinut</label>
          <textarea id="editRuleContent" rows="3"></textarea>
        </div>
        <button onclick="saveEditedCustomRule()">üíæ SalveazƒÉ</button>
      </div>
    </div>

    <!-- MODAL: Edit FAQ -->
    <div id="editFAQModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚úèÔ∏è EditeazƒÉ FAQ</h3>
          <button class="close-modal" onclick="closeEditFAQModal()">√ó</button>
        </div>
        <div class="form-group">
          <label>√éntrebare</label>
          <input type="text" id="editFAQQuestion" />
        </div>
        <div class="form-group">
          <label>RƒÉspuns</label>
          <textarea id="editFAQAnswer" rows="3"></textarea>
        </div>
        <button onclick="saveEditedFAQ()">üíæ SalveazƒÉ</button>
      </div>
    </div>
  </body>
</html>
<script>
      // ========== XSS PROTECTION ==========
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ========== GLOBAL VARIABLES ==========
      let currentConfig = {};
      let editingRuleIndex = -1;
      let editingFAQIndex = -1;

      // ========== TAB NAVIGATION ==========
      function showTab(tabId) {
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        document.getElementById(tabId).classList.add("active");
        event.target.classList.add("active");
      }

      // ========== PASSWORD HELPER ==========
      function getAdminPassword(fieldId) {
        const field = document.getElementById(fieldId);
        return field ? field.value : "";
      }

      function setAdminPassword(password) {
        const fields = [
          "adminPassword1",
          "adminPassword2",
          "adminPassword3",
          "adminPassword4",
          "productsPassword",
          "analyticsPassword",
        ];
        fields.forEach((id) => {
          const field = document.getElementById(id);
          if (field && !field.value) {
            field.value = password;
          }
        });
      }

      // ========== LOAD CONFIG ==========
      async function loadConfig() {
        try {
          const response = await fetch("/api/config");
          currentConfig = await response.json();

          // Populate Logistics
          const logistics = currentConfig.logistics || {};
          const contact = logistics.contact || {};
          const shipping = logistics.shipping || {};

          document.getElementById("contactEmail").value = contact.email || "";
          document.getElementById("contactPhone").value = contact.phone || "";
          document.getElementById("contactHours").value = contact.hours || "";
          document.getElementById("shippingDays").value = shipping.days || "";
          document.getElementById("shippingCost").value = shipping.cost_standard || "";
          document.getElementById("freeShippingThreshold").value = shipping.threshold_free_shipping || "";
          document.getElementById("returnPolicy").value = logistics.return_policy || "";

          // Populate Occasions
          displayOccasions(currentConfig.occasions || []);

          // Populate FAQ
          displayFAQs(currentConfig.faq || []);

          console.log("‚úÖ Config loaded");
        } catch (error) {
          console.error("‚ùå Error loading config:", error);
        }
      }

      // ========== DISPLAY OCCASIONS (XSS SAFE) ==========
      function displayOccasions(occasions) {
        const container = document.getElementById("occasionsList");
        container.innerHTML = "";

        if (!occasions || occasions.length === 0) {
          container.innerHTML = '<p style="color: #999;">Nicio ocazie adƒÉugatƒÉ</p>';
          return;
        }

        occasions.forEach((occ, index) => {
          const tag = document.createElement("div");
          tag.className = "tag";
          
          const nameSpan = document.createElement("span");
          nameSpan.textContent = occ.name || occ;
          
          const removeSpan = document.createElement("span");
          removeSpan.className = "remove-tag";
          removeSpan.textContent = "√ó";
          removeSpan.onclick = () => removeOccasion(index);
          
          tag.appendChild(nameSpan);
          tag.appendChild(removeSpan);
          container.appendChild(tag);
        });
      }

      // ========== DISPLAY FAQS (XSS SAFE) ==========
      function displayFAQs(faqs) {
        const container = document.getElementById("faqList");
        container.innerHTML = "";

        if (!faqs || faqs.length === 0) {
          container.innerHTML = '<p style="color: #999;">Niciun FAQ adƒÉugat</p>';
          return;
        }

        faqs.forEach((faq, index) => {
          const item = document.createElement("div");
          item.className = "faq-item";
          
          const question = document.createElement("h4");
          question.textContent = "Q: " + (faq.question || "");
          
          const answer = document.createElement("p");
          answer.textContent = "A: " + (faq.answer || "");
          
          const btnContainer = document.createElement("div");
          btnContainer.style.marginTop = "10px";
          
          const editBtn = document.createElement("button");
          editBtn.className = "edit-btn";
          editBtn.textContent = "‚úèÔ∏è Edit";
          editBtn.onclick = () => openEditFAQModal(index);
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "üóëÔ∏è »òterge";
          deleteBtn.onclick = () => deleteFAQ(index);
          
          btnContainer.appendChild(editBtn);
          btnContainer.appendChild(deleteBtn);
          
          item.appendChild(question);
          item.appendChild(answer);
          item.appendChild(btnContainer);
          container.appendChild(item);
        });
      }

      // ========== DISPLAY RULES (XSS SAFE) ==========
      function loadAndDisplaySavedRules() {
        fetch("/api/config")
          .then((r) => r.json())
          .then((config) => {
            const rules = config.custom_rules || [];
            const container = document.getElementById("rulesList");
            container.innerHTML = "";

            if (rules.length === 0) {
              container.innerHTML = '<p style="color: #999;">Nicio regulƒÉ adƒÉugatƒÉ</p>';
              return;
            }

            rules.forEach((rule, index) => {
              const item = document.createElement("div");
              item.className = "rule-item";
              
              const title = document.createElement("h4");
              title.textContent = (rule.title || "Untitled") + " (" + (rule.type || "custom") + ")";
              
              const content = document.createElement("p");
              content.textContent = rule.content || "";
              
              const btnContainer = document.createElement("div");
              btnContainer.style.marginTop = "10px";
              
              const editBtn = document.createElement("button");
              editBtn.className = "edit-btn";
              editBtn.textContent = "‚úèÔ∏è Edit";
              editBtn.onclick = () => openEditCustomRuleModal(index);
              
              const deleteBtn = document.createElement("button");
              deleteBtn.className = "delete-btn";
              deleteBtn.textContent = "üóëÔ∏è »òterge";
              deleteBtn.onclick = () => deleteSavedRule(index);
              
              btnContainer.appendChild(editBtn);
              btnContainer.appendChild(deleteBtn);
              
              item.appendChild(title);
              item.appendChild(content);
              item.appendChild(btnContainer);
              container.appendChild(item);
            });
          })
          .catch((error) => {
            console.error("Error loading rules:", error);
          });
      }

      // ========== SAVE LOGISTICS ==========
      async function saveLogistics() {
        const password = getAdminPassword("adminPassword1");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        const updatedConfig = {
          logistics: {
            contact: {
              email: document.getElementById("contactEmail").value,
              phone: document.getElementById("contactPhone").value,
              hours: document.getElementById("contactHours").value,
            },
            shipping: {
              days: document.getElementById("shippingDays").value,
              cost_standard: document.getElementById("shippingCost").value,
              threshold_free_shipping: document.getElementById("freeShippingThreshold").value,
            },
            return_policy: document.getElementById("returnPolicy").value,
            payment_methods: currentConfig.logistics?.payment_methods || [],
          },
          occasions: currentConfig.occasions || [],
          faq: currentConfig.faq || [],
          custom_rules: currentConfig.custom_rules || [],
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            const successEl = document.getElementById("logisticsSuccess");
            successEl.textContent = "‚úÖ Logistics salvat cu succes!";
            successEl.style.display = "block";
            setTimeout(() => {
              successEl.style.display = "none";
            }, 3000);
            loadConfig();
          } else {
            alert("‚ùå Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("‚ùå Eroare la salvare");
        }
      }

      // ========== ADD OCCASION ==========
      async function addOccasion() {
        const name = document.getElementById("occasionName").value.trim();
        const desc = document.getElementById("occasionDesc").value.trim();
        const password = getAdminPassword("adminPassword2");

        if (!name) {
          alert("Scrie numele ocaziei!");
          return;
        }

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        const occasions = currentConfig.occasions || [];
        occasions.push({
          id: name.toLowerCase().replace(/\s+/g, "_"),
          name: name,
          description: desc,
          color_suggestions: [],
          style_tips: "",
        });

        const updatedConfig = {
          ...currentConfig,
          occasions: occasions,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("‚úÖ Ocazie adƒÉugatƒÉ!");
            document.getElementById("occasionName").value = "";
            document.getElementById("occasionDesc").value = "";
            loadConfig();
          } else {
            alert("‚ùå Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("‚ùå Eroare la salvare");
        }
      }

      // ========== REMOVE OCCASION ==========
      async function removeOccasion(index) {
        const password = getAdminPassword("adminPassword2");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        if (!confirm("Sigur vrei sƒÉ »ôtergi aceastƒÉ ocazie?")) {
          return;
        }

        setAdminPassword(password);

        const occasions = currentConfig.occasions || [];
        occasions.splice(index, 1);

        const updatedConfig = {
          ...currentConfig,
          occasions: occasions,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("‚úÖ Ocazie »ôtearsƒÉ!");
            loadConfig();
          } else {
            alert("‚ùå Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("‚ùå Eroare la »ôtergere");
        }
      }

      // ========== ADD FAQ ==========
      async function addFAQ() {
        const question = document.getElementById("faqQuestion").value.trim();
        const answer = document.getElementById("faqAnswer").value.trim();
        const password = getAdminPassword("adminPassword3");

        if (!question || !answer) {
          alert("CompleteazƒÉ √Æntrebarea »ôi rƒÉspunsul!");
          return;
        }

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        const faqs = currentConfig.faq || [];
        faqs.push({ question: question, answer: answer });

        const updatedConfig = {
          ...currentConfig,
          faq: faqs,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("‚úÖ FAQ adƒÉugat!");
            document.getElementById("faqQuestion").value = "";
            document.getElementById("faqAnswer").value = "";
            loadConfig();
          } else {
            alert("‚ùå Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("‚ùå Eroare la salvare");
        }
      }

      // ========== DELETE FAQ ==========
      async function deleteFAQ(index) {
        const password = getAdminPassword("adminPassword3");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        if (!confirm("Sigur vrei sƒÉ »ôtergi acest FAQ?")) {
          return;
        }

        setAdminPassword(password);

        const faqs = currentConfig.faq || [];
        faqs.splice(index, 1);

        const updatedConfig = {
          ...currentConfig,
          faq: faqs,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("‚úÖ FAQ »ôters!");
            loadConfig();
          } else {
            alert("‚ùå Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("‚ùå Eroare la »ôtergere");
        }
      }

      // ========== EDIT FAQ MODAL ==========
      function openEditFAQModal(index) {
        editingFAQIndex = index;
        const faq = currentConfig.faq[index];
        document.getElementById("editFAQQuestion").value = faq.question || "";
        document.getElementById("editFAQAnswer").value = faq.answer || "";
        document.getElementById("editFAQModal").style.display = "block";
      }

      function closeEditFAQModal() {
        document.getElementById("editFAQModal").style.display = "none";
        editingFAQIndex = -1;
      }

      async function saveEditedFAQ() {
        const password = getAdminPassword("adminPassword3");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        currentConfig.faq[editingFAQIndex] = {
          question: document.getElementById("editFAQQuestion").value,
          answer: document.getElementById("editFAQAnswer").value,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: currentConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("‚úÖ FAQ actualizat!");
            closeEditFAQModal();
            loadConfig();
          } else {
            alert("‚ùå Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("‚ùå Eroare la salvare");
        }
      }

      // ========== ADD CUSTOM RULE ==========
      async function addCustomRule() {
        const title = document.getElementById("ruleTitle").value.trim();
        const type = document.getElementById("ruleType").value;
        const content = document.getElementById("ruleContent").value.trim();
        const password = getAdminPassword("adminPassword4");

        if (!title || !content) {
          alert("CompleteazƒÉ titlul »ôi con»õinutul!");
          return;
        }

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        const rules = currentConfig.custom_rules || [];
        rules.push({ title: title, type: type, content: content });

        const updatedConfig = {
          ...currentConfig,
          custom_rules: rules,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("‚úÖ RegulƒÉ adƒÉugatƒÉ!");
            document.getElementById("ruleTitle").value = "";
            document.getElementById("ruleContent").value = "";
            loadConfig();
            loadAndDisplaySavedRules();
          } else {
            alert("‚ùå Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("‚ùå Eroare la salvare");
        }
      }

      // ========== EDIT CUSTOM RULE MODAL ==========
      function openEditCustomRuleModal(index) {
        editingRuleIndex = index;
        fetch("/api/config")
          .then((r) => r.json())
          .then((config) => {
            const rule = config.custom_rules[index];
            document.getElementById("editRuleTitle").value = rule.title || "";
            document.getElementById("editRuleType").value = rule.type || "custom";
            document.getElementById("editRuleContent").value = rule.content || "";
            document.getElementById("editRuleModal").style.display = "block";
          });
      }

      function closeEditCustomRuleModal() {
        document.getElementById("editRuleModal").style.display = "none";
        editingRuleIndex = -1;
      }

      function saveEditedCustomRule() {
        const password = getAdminPassword("adminPassword4");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        fetch("/api/config")
          .then((r) => r.json())
          .then((config) => {
            config.custom_rules[editingRuleIndex] = {
              title: document.getElementById("editRuleTitle").value,
              type: document.getElementById("editRuleType").value,
              content: document.getElementById("editRuleContent").value,
            };

            return fetch("/api/admin/save-config", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Admin-Password": password,
              },
              body: JSON.stringify({ config: config }),
            });
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success" || data.status === "ok") {
              alert("‚úÖ RegulƒÉ actualizatƒÉ!");
              closeEditCustomRuleModal();
              loadConfig();
              loadAndDisplaySavedRules();
            } else {
              alert("‚ùå Eroare: " + (data.error || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("‚ùå Eroare la salvare");
          });
      }

      function deleteSavedRule(idx) {
        const password = getAdminPassword("adminPassword4");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        if (!confirm("Sigur vrei sƒÉ »ôtergi aceastƒÉ regulƒÉ?")) {
          return;
        }

        setAdminPassword(password);

        fetch("/api/config")
          .then((r) => r.json())
          .then((config) => {
            const rules = config.custom_rules || [];
            rules.splice(idx, 1);

            const updatedConfig = {
              logistics: config.logistics,
              occasions: config.occasions,
              faq: config.faq,
              custom_rules: rules,
            };

            return fetch("/api/admin/save-config", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Admin-Password": password,
              },
              body: JSON.stringify({ config: updatedConfig }),
            });
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success" || data.status === "ok") {
              alert("‚úÖ RegulƒÉ »ôtearsƒÉ!");
              loadAndDisplaySavedRules();
              loadConfig();
            } else {
              alert("‚ùå Eroare: " + (data.error || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("‚ùå Eroare la »ôtergere");
          });
      }

      // ========== SYNC FROM FEED (NOU!) ==========
      async function syncFromFeed() {
        const password = getAdminPassword("productsPassword");
        const successMsg = document.getElementById("uploadSuccessMsg");
        const errorMsg = document.getElementById("uploadErrorMsg");

        successMsg.style.display = "none";
        errorMsg.style.display = "none";

        if (!password) {
          errorMsg.textContent = "‚ùå Introdu parola";
          errorMsg.style.display = "block";
          return;
        }

        setAdminPassword(password);

        // Show loading message
        successMsg.textContent = "üîÑ Se sincronizeazƒÉ din feed ejolie.ro... (poate dura 30-60 secunde)";
        successMsg.style.display = "block";

        try {
          const response = await fetch("/api/admin/sync-feed", {
            method: "POST",
            headers: {
              "X-Admin-Password": password,
            },
          });

          const data = await response.json();

          if (response.ok && data.status === "success") {
            successMsg.textContent = `‚úÖ Sync complet! ${data.products_count} produse √ÆncƒÉrcate din feed-ul ejolie.ro`;
            successMsg.style.display = "block";
            
            document.getElementById("totalProducts").textContent = data.bot_products_loaded || data.products_count;
            document.getElementById("lastUpdated").textContent = new Date().toLocaleString("ro-RO");
            document.getElementById("dataSource").textContent = "Feed Auto";

            setTimeout(() => {
              successMsg.style.display = "none";
            }, 5000);
          } else {
            errorMsg.textContent = `‚ùå ${data.error || data.message || "Eroare la sincronizare"}`;
            errorMsg.style.display = "block";
            successMsg.style.display = "none";
          }
        } catch (error) {
          console.error("Sync error:", error);
          errorMsg.textContent = "‚ùå Eroare la sincronizare - verificƒÉ consola";
          errorMsg.style.display = "block";
          successMsg.style.display = "none";
        }
      }

      // ========== PRODUCTS UPLOAD (CSV MANUAL) ==========
      async function uploadProducts() {
        const file = document.getElementById("productsFile").files[0];
        const password = getAdminPassword("productsPassword");
        const successMsg = document.getElementById("uploadSuccessMsg");
        const errorMsg = document.getElementById("uploadErrorMsg");

        successMsg.style.display = "none";
        errorMsg.style.display = "none";

        if (!file) {
          errorMsg.textContent = "‚ùå SelecteazƒÉ un fi»ôier";
          errorMsg.style.display = "block";
          return;
        }

        if (!password) {
          errorMsg.textContent = "‚ùå Introdu parola";
          errorMsg.style.display = "block";
          return;
        }

        if (!file.name.endsWith(".csv")) {
          errorMsg.textContent = "‚ùå Doar fi»ôiere CSV sunt acceptate";
          errorMsg.style.display = "block";
          return;
        }

        setAdminPassword(password);

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/api/admin/upload-products", {
            method: "POST",
            headers: {
              "X-Admin-Password": password,
            },
            body: formData,
          });

          const data = await response.json();

          if (response.ok) {
            const removed = data.removed_count || 0;
            successMsg.textContent = "‚úÖ " + (data.message || "Produse sincronizate!");
            successMsg.style.display = "block";

            document.getElementById("totalProducts").textContent = data.products_count;
            document.getElementById("lastUpdated").textContent = new Date().toLocaleString("ro-RO");
            document.getElementById("dataSource").textContent = "CSV Manual";

            document.getElementById("productsFile").value = "";

            setTimeout(() => {
              successMsg.style.display = "none";
            }, 4000);
          } else {
            errorMsg.textContent = "‚ùå " + (data.error || "Eroare la upload");
            errorMsg.style.display = "block";
          }
        } catch (error) {
          console.error("Upload error:", error);
          errorMsg.textContent = "‚ùå Eroare la upload - verificƒÉ consola";
          errorMsg.style.display = "block";
        }
      }

      // ========== CHECK PRODUCTS STATUS ==========
      async function checkProductsStatus() {
        const password = getAdminPassword("productsPassword") || "admin123";
        const output = document.getElementById("statusOutput");
        output.style.display = "block";
        output.textContent = "Se verificƒÉ...";

        try {
          const response = await fetch("/api/admin/check-products?password=" + encodeURIComponent(password));
          const text = await response.text();

          console.log("Raw response:", text);

          try {
            const data = JSON.parse(text);

            if (data.error) {
              output.textContent = "‚ùå Eroare: " + data.error;
              return;
            }

            let html = "‚úÖ Fi»ôier existƒÉ: " + data.file_exists + "\n";
            html += "‚úÖ Dimensiune: " + (data.file_size || "N/A") + " bytes\n";
            html += "‚úÖ Produse √ÆncƒÉrcate: " + (data.bot_products_count || 0) + "\n";
            html += "‚úÖ Exemple produse:\n";
            html += JSON.stringify(data.bot_products_sample || [], null, 2);

            output.textContent = html;
            
            // Update stats
            document.getElementById("totalProducts").textContent = data.bot_products_count || 0;
          } catch (jsonError) {
            console.error("JSON Parse Error:", jsonError);
            output.textContent = "‚ùå JSON invalid: " + jsonError.message + "\n\nRƒÉspuns: " + text.substring(0, 200);
          }
        } catch (error) {
          console.error("Fetch Error:", error);
          output.textContent = "‚ùå Eroare: " + error.message;
        }
      }

      // ========== ANALYTICS (XSS SAFE) ==========
      async function loadConversations() {
        const password = document.getElementById("analyticsPassword").value;
        const list = document.getElementById("conversationsList");

        list.innerHTML = '<div class="loading">Se √ÆncarcƒÉ...</div>';

        try {
          const response = await fetch("/api/conversations?password=" + encodeURIComponent(password));
          const data = await response.json();

          if (data.error) {
            list.innerHTML = '<div class="no-data">‚ùå ParolƒÉ gre»ôitƒÉ!</div>';
            return;
          }

          document.getElementById("totalConversations").textContent = data.length;

          if (data.length === 0) {
            list.innerHTML = '<div class="no-data">üì≠ Nicio conversa»õie √ÆncƒÉ</div>';
            return;
          }

          // Clear and rebuild with XSS protection
          list.innerHTML = "";
          
          data.forEach((conv) => {
            const date = new Date(conv.timestamp).toLocaleString("ro-RO");
            
            const item = document.createElement("div");
            item.className = "conversation-item";
            
            // Time
            const timeDiv = document.createElement("div");
            timeDiv.className = "conversation-time";
            timeDiv.textContent = "‚è∞ " + date;
            
            // User message (XSS SAFE)
            const userDiv = document.createElement("div");
            userDiv.className = "conversation-user";
            const userStrong = document.createElement("strong");
            userStrong.textContent = "üë§ Client:";
            const userText = document.createTextNode(" " + (conv.user_message || "").substring(0, 80) + (conv.user_message && conv.user_message.length > 80 ? "..." : ""));
            userDiv.appendChild(userStrong);
            userDiv.appendChild(userText);
            
            // Bot response (XSS SAFE)
            const botDiv = document.createElement("div");
            botDiv.className = "conversation-response";
            const botStrong = document.createElement("strong");
            botStrong.textContent = "ü§ñ Bot:";
            const botBr = document.createElement("br");
            const botText = document.createTextNode((conv.bot_response || "").substring(0, 150) + (conv.bot_response && conv.bot_response.length > 150 ? "..." : ""));
            botDiv.appendChild(botStrong);
            botDiv.appendChild(botBr);
            botDiv.appendChild(botText);
            
            item.appendChild(timeDiv);
            item.appendChild(userDiv);
            item.appendChild(botDiv);
            list.appendChild(item);
          });
        } catch (error) {
          console.error("Error:", error);
          list.innerHTML = '<div class="no-data">‚ùå Eroare la √ÆncƒÉrcarea conversa»õiilor</div>';
        }
      }

      // ========== INIT ==========
      window.addEventListener("load", function () {
        loadConfig();
        loadAndDisplaySavedRules();

        fetch("/health")
          .then((r) => r.json())
          .then((data) => {
            document.getElementById("totalProducts").textContent = data.products_loaded;
          })
          .catch((e) => console.log("Health check failed:", e));
      });

      // Close modals on ESC key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeEditCustomRuleModal();
          closeEditFAQModal();
        }
      });

      // Close modals on outside click
      window.addEventListener("click", function (event) {
        if (event.target.classList.contains("modal")) {
          closeEditCustomRuleModal();
          closeEditFAQModal();
        }
      });
    </script>
  </body>
</html>
