<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Ejolie Chat</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .admin-header {
        background: linear-gradient(135deg, #1a5490, #2a7bb8);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .admin-header h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid #e0e0e0;
        background: #f9f9f9;
        overflow-x: auto;
      }

      .tab-btn {
        padding: 15px 25px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .tab-btn:hover {
        background: #f0f0f0;
      }

      .tab-btn.active {
        color: #1a5490;
        border-bottom-color: #1a5490;
        background: white;
      }

      .tab-content {
        display: none;
        padding: 30px;
        animation: fadeIn 0.3s ease;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      input[type="password"],
      input[type="text"],
      input[type="file"],
      textarea {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.3s ease;
      }

      input[type="password"]:focus,
      input[type="text"]:focus,
      input[type="file"]:focus,
      textarea:focus {
        outline: none;
        border-color: #1a5490;
      }

      textarea {
        resize: vertical;
        min-height: 100px;
      }

      button {
        background: linear-gradient(135deg, #1a5490, #2a7bb8);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      button:hover {
        box-shadow: 0 4px 12px rgba(26, 84, 144, 0.3);
        transform: translateY(-2px);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .delete-btn {
        background: #dc3545;
        padding: 8px 15px;
        font-size: 13px;
        margin: 5px 0;
      }

      .delete-btn:hover {
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
      }

      .edit-btn {
        background: #ffc107;
        color: #000;
        padding: 8px 15px;
        font-size: 13px;
        margin: 5px 0;
      }

      .edit-btn:hover {
        background: #ffb300;
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      }

      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
      }

      .section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
      }

      .section:last-child {
        border-bottom: none;
      }

      .section h3 {
        color: #1a5490;
        margin-bottom: 15px;
        font-size: 18px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .analytics-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #1a5490, #2a7bb8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-card h4 {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-card .number {
        font-size: 32px;
        font-weight: bold;
      }

      .conversations-list {
        max-height: 700px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #f9f9f9;
      }

      .conversation-item {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        background: white;
        margin: 5px;
        border-radius: 6px;
      }

      .conversation-item:last-child {
        border-bottom: none;
      }

      .conversation-item:hover {
        background: #f0f7ff;
      }

      .conversation-time {
        font-size: 12px;
        color: #999;
        margin-bottom: 8px;
      }

      .conversation-user {
        font-weight: 600;
        color: #1a5490;
        margin-bottom: 8px;
        padding: 8px;
        background: #e8f0f7;
        border-radius: 4px;
      }

      .conversation-user strong {
        display: block;
        margin-bottom: 4px;
      }

      .conversation-response {
        color: #333;
        font-size: 14px;
        line-height: 1.5;
        padding: 8px;
        background: #f5f5f5;
        border-radius: 4px;
      }

      .conversation-response strong {
        color: #1a5490;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .tag {
        background: #e8f0f7;
        color: #1a5490;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .tag .remove-tag {
        cursor: pointer;
        color: #dc3545;
        font-weight: bold;
      }

      .faq-item,
      .rule-item {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #1a5490;
      }

      .faq-item h4,
      .rule-item h4 {
        color: #1a5490;
        margin-bottom: 8px;
      }

      .faq-item p,
      .rule-item p {
        color: #666;
        font-size: 14px;
      }

      .status-output {
        background: #f0f0f0;
        padding: 15px;
        border-radius: 8px;
        font-family: monospace;
        white-space: pre-wrap;
        margin-top: 15px;
        display: none;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-header h3 {
        color: #1a5490;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        padding: 0;
        margin: 0;
      }

      .close-modal:hover {
        color: #333;
        box-shadow: none;
        transform: none;
      }

      .sync-feed-btn {
        background: linear-gradient(135deg, #17a2b8, #138496);
      }

      .sync-feed-btn:hover {
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }

        .tabs {
          flex-wrap: nowrap;
        }

        .tab-btn {
          padding: 12px 15px;
          font-size: 12px;
        }

        .admin-header h1 {
          font-size: 22px;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <h1>âš™ï¸ Admin Panel - Ejolie Chat</h1>
        <p>GestioneazÄƒ chatbot-ul È™i vezi analytics</p>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('logistics')">
          ğŸ“¦ Logistics
        </button>
        <button class="tab-btn" onclick="showTab('occasions')">
          ğŸ­ Occasions
        </button>
        <button class="tab-btn" onclick="showTab('faq')">ğŸ’¬ FAQ</button>
        <button class="tab-btn" onclick="showTab('rules')">
          âš™ï¸ Custom Rules
        </button>
        <button class="tab-btn" onclick="showTab('products')">
          ğŸ“¦ Products
        </button>
        <button class="tab-btn" onclick="showTab('analytics')">
          ğŸ“Š Analytics
        </button>
      </div>

      <!-- TAB 1: LOGISTICS -->
      <div id="logistics" class="tab-content active">
        <h2>ğŸ“¦ Logistics Settings</h2>
        <p style="color: #666; margin-bottom: 20px">
          ConfigureazÄƒ informaÈ›iile de contact, livrare È™i retur.
        </p>

        <div id="logisticsSuccess" class="success-message"></div>
        <div id="logisticsError" class="error-message"></div>

        <div class="section">
          <h3>ğŸ“ Contact</h3>
          <div class="grid">
            <div class="form-group">
              <label>Email</label>
              <input
                type="text"
                id="contactEmail"
                placeholder="contact@ejolie.ro"
              />
            </div>
            <div class="form-group">
              <label>Telefon</label>
              <input
                type="text"
                id="contactPhone"
                placeholder="+40 XXX XXX XXX"
              />
            </div>
            <div class="form-group">
              <label>Program</label>
              <input
                type="text"
                id="contactHours"
                placeholder="Luni - Vineri, 09:00 - 18:00"
              />
            </div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸšš Livrare</h3>
          <div class="grid">
            <div class="form-group">
              <label>Timp livrare</label>
              <input type="text" id="shippingDays" placeholder="3-5 zile" />
            </div>
            <div class="form-group">
              <label>Cost standard (RON)</label>
              <input type="text" id="shippingCost" placeholder="25" />
            </div>
            <div class="form-group">
              <label>Prag livrare gratuitÄƒ (RON)</label>
              <input type="text" id="freeShippingThreshold" placeholder="200" />
            </div>
          </div>
        </div>

        <div class="section">
          <h3>â†©ï¸ PoliticÄƒ Retur</h3>
          <div class="form-group">
            <label>Detalii retur</label>
            <textarea
              id="returnPolicy"
              rows="4"
              placeholder="Retur gratuit Ã®n 30 de zile..."
            ></textarea>
          </div>
        </div>

        <div class="form-group">
          <label>ğŸ” ParolÄƒ Admin</label>
          <input type="password" id="adminPassword1" placeholder="Parola" />
        </div>

        <button onclick="saveLogistics()">ğŸ’¾ SalveazÄƒ Logistics</button>
      </div>

      <!-- TAB 2: OCCASIONS -->
      <div id="occasions" class="tab-content">
        <h2>ğŸ­ Occasions Management</h2>
        <p style="color: #666; margin-bottom: 20px">
          AdaugÄƒ ocazii pentru recomandÄƒri (nuntÄƒ, botez, etc.)
        </p>

        <div id="occasionsSuccess" class="success-message"></div>
        <div id="occasionsError" class="error-message"></div>

        <div class="section">
          <h3>Ocazii existente</h3>
          <div id="occasionsList" class="tag-list">
            <!-- Se populeazÄƒ din JS -->
          </div>
        </div>

        <div class="section">
          <h3>â• AdaugÄƒ ocazie nouÄƒ</h3>
          <div class="grid">
            <div class="form-group">
              <label>Nume ocazie</label>
              <input type="text" id="occasionName" placeholder="ex: NuntÄƒ" />
            </div>
            <div class="form-group">
              <label>Descriere</label>
              <input
                type="text"
                id="occasionDesc"
                placeholder="ex: Rochii elegante pentru nuntÄƒ"
              />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>ğŸ” ParolÄƒ Admin</label>
          <input type="password" id="adminPassword2" placeholder="Parola" />
        </div>

        <button onclick="addOccasion()">â• AdaugÄƒ Ocazie</button>
      </div>

      <!-- TAB 3: FAQ -->
      <div id="faq" class="tab-content">
        <h2>ğŸ’¬ FAQ Management</h2>
        <p style="color: #666; margin-bottom: 20px">
          GestioneazÄƒ Ã®ntrebÄƒrile frecvente È™i rÄƒspunsurile.
        </p>

        <div id="faqSuccess" class="success-message"></div>
        <div id="faqError" class="error-message"></div>

        <div class="section">
          <h3>FAQ-uri existente</h3>
          <div id="faqList">
            <!-- Se populeazÄƒ din JS -->
          </div>
        </div>

        <div class="section">
          <h3>â• AdaugÄƒ FAQ nou</h3>
          <div class="form-group">
            <label>Ãntrebare</label>
            <input
              type="text"
              id="faqQuestion"
              placeholder="ex: CÃ¢t dureazÄƒ livrarea?"
            />
          </div>
          <div class="form-group">
            <label>RÄƒspuns</label>
            <textarea
              id="faqAnswer"
              rows="3"
              placeholder="ex: Livrarea dureazÄƒ 3-5 zile lucrÄƒtoare..."
            ></textarea>
          </div>
        </div>

        <div class="form-group">
          <label>ğŸ” ParolÄƒ Admin</label>
          <input type="password" id="adminPassword3" placeholder="Parola" />
        </div>

        <button onclick="addFAQ()">â• AdaugÄƒ FAQ</button>
      </div>

      <!-- TAB 4: CUSTOM RULES -->
      <div id="rules" class="tab-content">
        <h2>âš™ï¸ Custom Rules</h2>
        <p style="color: #666; margin-bottom: 20px">
          AdaugÄƒ reguli personalizate pentru chatbot.
        </p>

        <div id="rulesSuccess" class="success-message"></div>
        <div id="rulesError" class="error-message"></div>

        <div class="section">
          <h3>Reguli existente</h3>
          <div id="rulesList">
            <!-- Se populeazÄƒ din JS -->
          </div>
        </div>

        <div class="section">
          <h3>â• AdaugÄƒ regulÄƒ nouÄƒ</h3>
          <div class="form-group">
            <label>Titlu</label>
            <input
              type="text"
              id="ruleTitle"
              placeholder="ex: Salut personalizat"
            />
          </div>
          <div class="form-group">
            <label>Tip</label>
            <select
              id="ruleType"
              style="
                width: 100%;
                padding: 10px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
              "
            >
              <option value="greeting">Greeting</option>
              <option value="restriction">Restriction</option>
              <option value="promotion">Promotion</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="form-group">
            <label>ConÈ›inut</label>
            <textarea
              id="ruleContent"
              rows="3"
              placeholder="ex: Ãntotdeauna salutÄƒ cu 'BunÄƒ ziua!'"
            ></textarea>
          </div>
        </div>

        <div class="form-group">
          <label>ğŸ” ParolÄƒ Admin</label>
          <input type="password" id="adminPassword4" placeholder="Parola" />
        </div>

        <button onclick="addCustomRule()">â• AdaugÄƒ RegulÄƒ</button>
      </div>

      <!-- TAB 5: PRODUCTS -->
      <div id="products" class="tab-content">
        <h2>ğŸ“¦ Products Management</h2>
        <p style="color: #666; margin-bottom: 20px">
          SincronizeazÄƒ produsele automat din feed sau uploadeazÄƒ CSV manual.
        </p>

        <div id="uploadSuccessMsg" class="success-message"></div>
        <div id="uploadErrorMsg" class="error-message"></div>

        <div class="section">
          <h3>ğŸ“Š Status Produse</h3>
          <div class="analytics-stats">
            <div class="stat-card">
              <h4>Total Produse</h4>
              <div class="number" id="totalProducts">0</div>
            </div>
            <div class="stat-card">
              <h4>Ultima Actualizare</h4>
              <div class="number" id="lastUpdated" style="font-size: 16px">
                -
              </div>
            </div>
            <div class="stat-card">
              <h4>SursÄƒ Date</h4>
              <div class="number" id="dataSource" style="font-size: 16px">
                -
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸŒ Sync Automat din Feed</h3>
          <p style="color: #666; margin-bottom: 15px; font-size: 14px">
            DescarcÄƒ automat toate produsele de pe ejolie.ro (din feed-ul
            Facebook).
            <br />Nu mai trebuie sÄƒ uploadezi CSV manual!
          </p>
          <div class="form-group">
            <label>ğŸ” ParolÄƒ Admin</label>
            <input type="password" id="productsPassword" placeholder="Parola" />
          </div>
          <button onclick="syncFromFeed()" class="sync-feed-btn">
            ğŸŒ Sync din Feed (Automat)
          </button>
          <button onclick="checkProductsStatus()" style="background: #28a745">
            ğŸ” Check Status
          </button>
        </div>

        <div class="section">
          <h3>ğŸ“¤ Upload CSV Manual (OpÈ›ional)</h3>
          <p style="color: #666; margin-bottom: 15px; font-size: 14px">
            Alternativ, poÈ›i uploada un fiÈ™ier CSV manual.
            <br />Format:
            <code
              >Nume, Pret vanzare (cu promotie), Descriere, Stoc numeric, Link
              produs</code
            >
          </p>
          <div class="form-group">
            <label>SelecteazÄƒ fiÈ™ier CSV</label>
            <input type="file" id="productsFile" accept=".csv" />
          </div>
          <button onclick="uploadProducts()">ğŸ“¤ Upload CSV</button>
        </div>

        <div id="statusOutput" class="status-output"></div>
      </div>

      <!-- TAB 6: ANALYTICS -->
      <div id="analytics" class="tab-content">
        <h2>ğŸ“Š Analytics & ConversaÈ›ii</h2>
        <p style="color: #666; margin-bottom: 20px">
          VizualizeazÄƒ toate conversaÈ›iile cu clienÈ›ii.
        </p>

        <div class="analytics-header">
          <div class="analytics-stats" style="margin-bottom: 0">
            <div class="stat-card">
              <h4>Total ConversaÈ›ii</h4>
              <div class="number" id="totalConversations">0</div>
            </div>
          </div>
          <div>
            <input
              type="password"
              id="analyticsPassword"
              placeholder="ParolÄƒ admin"
              style="
                padding: 10px;
                border-radius: 6px;
                border: 2px solid #e0e0e0;
              "
            />
            <button onclick="loadConversations()">ğŸ”„ ReÃ®ncarcÄƒ</button>
          </div>
        </div>

        <div class="conversations-list" id="conversationsList">
          <div class="no-data">
            ğŸ” Introdu parola pentru a vedea conversaÈ›iile
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: Edit Custom Rule -->
    <div id="editRuleModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>âœï¸ EditeazÄƒ RegulÄƒ</h3>
          <button class="close-modal" onclick="closeEditCustomRuleModal()">
            Ã—
          </button>
        </div>
        <div class="form-group">
          <label>Titlu</label>
          <input type="text" id="editRuleTitle" />
        </div>
        <div class="form-group">
          <label>Tip</label>
          <select
            id="editRuleType"
            style="
              width: 100%;
              padding: 10px;
              border: 2px solid #e0e0e0;
              border-radius: 6px;
            "
          >
            <option value="greeting">Greeting</option>
            <option value="restriction">Restriction</option>
            <option value="promotion">Promotion</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="form-group">
          <label>ConÈ›inut</label>
          <textarea id="editRuleContent" rows="3"></textarea>
        </div>
        <button onclick="saveEditedCustomRule()">ğŸ’¾ SalveazÄƒ</button>
      </div>
    </div>

    <!-- MODAL: Edit FAQ -->
    <div id="editFAQModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>âœï¸ EditeazÄƒ FAQ</h3>
          <button class="close-modal" onclick="closeEditFAQModal()">Ã—</button>
        </div>
        <div class="form-group">
          <label>Ãntrebare</label>
          <input type="text" id="editFAQQuestion" />
        </div>
        <div class="form-group">
          <label>RÄƒspuns</label>
          <textarea id="editFAQAnswer" rows="3"></textarea>
        </div>
        <button onclick="saveEditedFAQ()">ğŸ’¾ SalveazÄƒ</button>
      </div>
    </div>
  </body>
</html>
<script>
      // ========== XSS PROTECTION ==========
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ========== GLOBAL VARIABLES ==========
      let currentConfig = {};
      let editingRuleIndex = -1;
      let editingFAQIndex = -1;

      // ========== TAB NAVIGATION ==========
      function showTab(tabId) {
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        document.getElementById(tabId).classList.add("active");
        event.target.classList.add("active");
      }

      // ========== PASSWORD HELPER ==========
      function getAdminPassword(fieldId) {
        const field = document.getElementById(fieldId);
        return field ? field.value : "";
      }

      function setAdminPassword(password) {
        const fields = [
          "adminPassword1",
          "adminPassword2",
          "adminPassword3",
          "adminPassword4",
          "productsPassword",
          "analyticsPassword",
        ];
        fields.forEach((id) => {
          const field = document.getElementById(id);
          if (field && !field.value) {
            field.value = password;
          }
        });
      }

      // ========== LOAD CONFIG ==========
      async function loadConfig() {
        try {
          const response = await fetch("/api/config");
          currentConfig = await response.json();

          // Populate Logistics
          const logistics = currentConfig.logistics || {};
          const contact = logistics.contact || {};
          const shipping = logistics.shipping || {};

          document.getElementById("contactEmail").value = contact.email || "";
          document.getElementById("contactPhone").value = contact.phone || "";
          document.getElementById("contactHours").value = contact.hours || "";
          document.getElementById("shippingDays").value = shipping.days || "";
          document.getElementById("shippingCost").value = shipping.cost_standard || "";
          document.getElementById("freeShippingThreshold").value = shipping.threshold_free_shipping || "";
          document.getElementById("returnPolicy").value = logistics.return_policy || "";

          // Populate Occasions
          displayOccasions(currentConfig.occasions || []);

          // Populate FAQ
          displayFAQs(currentConfig.faq || []);

          console.log("âœ… Config loaded");
        } catch (error) {
          console.error("âŒ Error loading config:", error);
        }
      }

      // ========== DISPLAY OCCASIONS (XSS SAFE) ==========
      function displayOccasions(occasions) {
        const container = document.getElementById("occasionsList");
        container.innerHTML = "";

        if (!occasions || occasions.length === 0) {
          container.innerHTML = '<p style="color: #999;">Nicio ocazie adÄƒugatÄƒ</p>';
          return;
        }

        occasions.forEach((occ, index) => {
          const tag = document.createElement("div");
          tag.className = "tag";
          
          const nameSpan = document.createElement("span");
          nameSpan.textContent = occ.name || occ;
          
          const removeSpan = document.createElement("span");
          removeSpan.className = "remove-tag";
          removeSpan.textContent = "Ã—";
          removeSpan.onclick = () => removeOccasion(index);
          
          tag.appendChild(nameSpan);
          tag.appendChild(removeSpan);
          container.appendChild(tag);
        });
      }

      // ========== DISPLAY FAQS (XSS SAFE) ==========
      function displayFAQs(faqs) {
        const container = document.getElementById("faqList");
        container.innerHTML = "";

        if (!faqs || faqs.length === 0) {
          container.innerHTML = '<p style="color: #999;">Niciun FAQ adÄƒugat</p>';
          return;
        }

        faqs.forEach((faq, index) => {
          const item = document.createElement("div");
          item.className = "faq-item";
          
          const question = document.createElement("h4");
          question.textContent = "Q: " + (faq.question || "");
          
          const answer = document.createElement("p");
          answer.textContent = "A: " + (faq.answer || "");
          
          const btnContainer = document.createElement("div");
          btnContainer.style.marginTop = "10px";
          
          const editBtn = document.createElement("button");
          editBtn.className = "edit-btn";
          editBtn.textContent = "âœï¸ Edit";
          editBtn.onclick = () => openEditFAQModal(index);
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "ğŸ—‘ï¸ È˜terge";
          deleteBtn.onclick = () => deleteFAQ(index);
          
          btnContainer.appendChild(editBtn);
          btnContainer.appendChild(deleteBtn);
          
          item.appendChild(question);
          item.appendChild(answer);
          item.appendChild(btnContainer);
          container.appendChild(item);
        });
      }

      // ========== DISPLAY RULES (XSS SAFE) ==========
      function loadAndDisplaySavedRules() {
        fetch("/api/config")
          .then((r) => r.json())
          .then((config) => {
            const rules = config.custom_rules || [];
            const container = document.getElementById("rulesList");
            container.innerHTML = "";

            if (rules.length === 0) {
              container.innerHTML = '<p style="color: #999;">Nicio regulÄƒ adÄƒugatÄƒ</p>';
              return;
            }

            rules.forEach((rule, index) => {
              const item = document.createElement("div");
              item.className = "rule-item";
              
              const title = document.createElement("h4");
              title.textContent = (rule.title || "Untitled") + " (" + (rule.type || "custom") + ")";
              
              const content = document.createElement("p");
              content.textContent = rule.content || "";
              
              const btnContainer = document.createElement("div");
              btnContainer.style.marginTop = "10px";
              
              const editBtn = document.createElement("button");
              editBtn.className = "edit-btn";
              editBtn.textContent = "âœï¸ Edit";
              editBtn.onclick = () => openEditCustomRuleModal(index);
              
              const deleteBtn = document.createElement("button");
              deleteBtn.className = "delete-btn";
              deleteBtn.textContent = "ğŸ—‘ï¸ È˜terge";
              deleteBtn.onclick = () => deleteSavedRule(index);
              
              btnContainer.appendChild(editBtn);
              btnContainer.appendChild(deleteBtn);
              
              item.appendChild(title);
              item.appendChild(content);
              item.appendChild(btnContainer);
              container.appendChild(item);
            });
          })
          .catch((error) => {
            console.error("Error loading rules:", error);
          });
      }

      // ========== SAVE LOGISTICS ==========
      async function saveLogistics() {
        const password = getAdminPassword("adminPassword1");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        const updatedConfig = {
          logistics: {
            contact: {
              email: document.getElementById("contactEmail").value,
              phone: document.getElementById("contactPhone").value,
              hours: document.getElementById("contactHours").value,
            },
            shipping: {
              days: document.getElementById("shippingDays").value,
              cost_standard: document.getElementById("shippingCost").value,
              threshold_free_shipping: document.getElementById("freeShippingThreshold").value,
            },
            return_policy: document.getElementById("returnPolicy").value,
            payment_methods: currentConfig.logistics?.payment_methods || [],
          },
          occasions: currentConfig.occasions || [],
          faq: currentConfig.faq || [],
          custom_rules: currentConfig.custom_rules || [],
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            const successEl = document.getElementById("logisticsSuccess");
            successEl.textContent = "âœ… Logistics salvat cu succes!";
            successEl.style.display = "block";
            setTimeout(() => {
              successEl.style.display = "none";
            }, 3000);
            loadConfig();
          } else {
            alert("âŒ Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("âŒ Eroare la salvare");
        }
      }

      // ========== ADD OCCASION ==========
      async function addOccasion() {
        const name = document.getElementById("occasionName").value.trim();
        const desc = document.getElementById("occasionDesc").value.trim();
        const password = getAdminPassword("adminPassword2");

        if (!name) {
          alert("Scrie numele ocaziei!");
          return;
        }

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        const occasions = currentConfig.occasions || [];
        occasions.push({
          id: name.toLowerCase().replace(/\s+/g, "_"),
          name: name,
          description: desc,
          color_suggestions: [],
          style_tips: "",
        });

        const updatedConfig = {
          ...currentConfig,
          occasions: occasions,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("âœ… Ocazie adÄƒugatÄƒ!");
            document.getElementById("occasionName").value = "";
            document.getElementById("occasionDesc").value = "";
            loadConfig();
          } else {
            alert("âŒ Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("âŒ Eroare la salvare");
        }
      }

      // ========== REMOVE OCCASION ==========
      async function removeOccasion(index) {
        const password = getAdminPassword("adminPassword2");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        if (!confirm("Sigur vrei sÄƒ È™tergi aceastÄƒ ocazie?")) {
          return;
        }

        setAdminPassword(password);

        const occasions = currentConfig.occasions || [];
        occasions.splice(index, 1);

        const updatedConfig = {
          ...currentConfig,
          occasions: occasions,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("âœ… Ocazie È™tearsÄƒ!");
            loadConfig();
          } else {
            alert("âŒ Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("âŒ Eroare la È™tergere");
        }
      }

      // ========== ADD FAQ ==========
      async function addFAQ() {
        const question = document.getElementById("faqQuestion").value.trim();
        const answer = document.getElementById("faqAnswer").value.trim();
        const password = getAdminPassword("adminPassword3");

        if (!question || !answer) {
          alert("CompleteazÄƒ Ã®ntrebarea È™i rÄƒspunsul!");
          return;
        }

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        const faqs = currentConfig.faq || [];
        faqs.push({ question: question, answer: answer });

        const updatedConfig = {
          ...currentConfig,
          faq: faqs,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("âœ… FAQ adÄƒugat!");
            document.getElementById("faqQuestion").value = "";
            document.getElementById("faqAnswer").value = "";
            loadConfig();
          } else {
            alert("âŒ Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("âŒ Eroare la salvare");
        }
      }

      // ========== DELETE FAQ ==========
      async function deleteFAQ(index) {
        const password = getAdminPassword("adminPassword3");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        if (!confirm("Sigur vrei sÄƒ È™tergi acest FAQ?")) {
          return;
        }

        setAdminPassword(password);

        const faqs = currentConfig.faq || [];
        faqs.splice(index, 1);

        const updatedConfig = {
          ...currentConfig,
          faq: faqs,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("âœ… FAQ È™ters!");
            loadConfig();
          } else {
            alert("âŒ Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("âŒ Eroare la È™tergere");
        }
      }

      // ========== EDIT FAQ MODAL ==========
      function openEditFAQModal(index) {
        editingFAQIndex = index;
        const faq = currentConfig.faq[index];
        document.getElementById("editFAQQuestion").value = faq.question || "";
        document.getElementById("editFAQAnswer").value = faq.answer || "";
        document.getElementById("editFAQModal").style.display = "block";
      }

      function closeEditFAQModal() {
        document.getElementById("editFAQModal").style.display = "none";
        editingFAQIndex = -1;
      }

      async function saveEditedFAQ() {
        const password = getAdminPassword("adminPassword3");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        currentConfig.faq[editingFAQIndex] = {
          question: document.getElementById("editFAQQuestion").value,
          answer: document.getElementById("editFAQAnswer").value,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: currentConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("âœ… FAQ actualizat!");
            closeEditFAQModal();
            loadConfig();
          } else {
            alert("âŒ Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("âŒ Eroare la salvare");
        }
      }

      // ========== ADD CUSTOM RULE ==========
      async function addCustomRule() {
        const title = document.getElementById("ruleTitle").value.trim();
        const type = document.getElementById("ruleType").value;
        const content = document.getElementById("ruleContent").value.trim();
        const password = getAdminPassword("adminPassword4");

        if (!title || !content) {
          alert("CompleteazÄƒ titlul È™i conÈ›inutul!");
          return;
        }

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        const rules = currentConfig.custom_rules || [];
        rules.push({ title: title, type: type, content: content });

        const updatedConfig = {
          ...currentConfig,
          custom_rules: rules,
        };

        try {
          const response = await fetch("/api/admin/save-config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Admin-Password": password,
            },
            body: JSON.stringify({ config: updatedConfig }),
          });

          const data = await response.json();

          if (data.status === "success" || data.status === "ok") {
            alert("âœ… RegulÄƒ adÄƒugatÄƒ!");
            document.getElementById("ruleTitle").value = "";
            document.getElementById("ruleContent").value = "";
            loadConfig();
            loadAndDisplaySavedRules();
          } else {
            alert("âŒ Eroare: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("âŒ Eroare la salvare");
        }
      }

      // ========== EDIT CUSTOM RULE MODAL ==========
      function openEditCustomRuleModal(index) {
        editingRuleIndex = index;
        fetch("/api/config")
          .then((r) => r.json())
          .then((config) => {
            const rule = config.custom_rules[index];
            document.getElementById("editRuleTitle").value = rule.title || "";
            document.getElementById("editRuleType").value = rule.type || "custom";
            document.getElementById("editRuleContent").value = rule.content || "";
            document.getElementById("editRuleModal").style.display = "block";
          });
      }

      function closeEditCustomRuleModal() {
        document.getElementById("editRuleModal").style.display = "none";
        editingRuleIndex = -1;
      }

      function saveEditedCustomRule() {
        const password = getAdminPassword("adminPassword4");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        setAdminPassword(password);

        fetch("/api/config")
          .then((r) => r.json())
          .then((config) => {
            config.custom_rules[editingRuleIndex] = {
              title: document.getElementById("editRuleTitle").value,
              type: document.getElementById("editRuleType").value,
              content: document.getElementById("editRuleContent").value,
            };

            return fetch("/api/admin/save-config", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Admin-Password": password,
              },
              body: JSON.stringify({ config: config }),
            });
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success" || data.status === "ok") {
              alert("âœ… RegulÄƒ actualizatÄƒ!");
              closeEditCustomRuleModal();
              loadConfig();
              loadAndDisplaySavedRules();
            } else {
              alert("âŒ Eroare: " + (data.error || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("âŒ Eroare la salvare");
          });
      }

      function deleteSavedRule(idx) {
        const password = getAdminPassword("adminPassword4");

        if (!password) {
          alert("Scrie parola!");
          return;
        }

        if (!confirm("Sigur vrei sÄƒ È™tergi aceastÄƒ regulÄƒ?")) {
          return;
        }

        setAdminPassword(password);

        fetch("/api/config")
          .then((r) => r.json())
          .then((config) => {
            const rules = config.custom_rules || [];
            rules.splice(idx, 1);

            const updatedConfig = {
              logistics: config.logistics,
              occasions: config.occasions,
              faq: config.faq,
              custom_rules: rules,
            };

            return fetch("/api/admin/save-config", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Admin-Password": password,
              },
              body: JSON.stringify({ config: updatedConfig }),
            });
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success" || data.status === "ok") {
              alert("âœ… RegulÄƒ È™tearsÄƒ!");
              loadAndDisplaySavedRules();
              loadConfig();
            } else {
              alert("âŒ Eroare: " + (data.error || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("âŒ Eroare la È™tergere");
          });
      }

      // ========== SYNC FROM FEED (NOU!) ==========
      async function syncFromFeed() {
        const password = getAdminPassword("productsPassword");
        const successMsg = document.getElementById("uploadSuccessMsg");
        const errorMsg = document.getElementById("uploadErrorMsg");

        successMsg.style.display = "none";
        errorMsg.style.display = "none";

        if (!password) {
          errorMsg.textContent = "âŒ Introdu parola";
          errorMsg.style.display = "block";
          return;
        }

        setAdminPassword(password);

        // Show loading message
        successMsg.textContent = "ğŸ”„ Se sincronizeazÄƒ din feed ejolie.ro... (poate dura 30-60 secunde)";
        successMsg.style.display = "block";

        try {
          const response = await fetch("/api/admin/sync-feed", {
            method: "POST",
            headers: {
              "X-Admin-Password": password,
            },
          });

          const data = await response.json();

          if (response.ok && data.status === "success") {
            successMsg.textContent = `âœ… Sync complet! ${data.products_count} produse Ã®ncÄƒrcate din feed-ul ejolie.ro`;
            successMsg.style.display = "block";
            
            document.getElementById("totalProducts").textContent = data.bot_products_loaded || data.products_count;
            document.getElementById("lastUpdated").textContent = new Date().toLocaleString("ro-RO");
            document.getElementById("dataSource").textContent = "Feed Auto";

            setTimeout(() => {
              successMsg.style.display = "none";
            }, 5000);
          } else {
            errorMsg.textContent = `âŒ ${data.error || data.message || "Eroare la sincronizare"}`;
            errorMsg.style.display = "block";
            successMsg.style.display = "none";
          }
        } catch (error) {
          console.error("Sync error:", error);
          errorMsg.textContent = "âŒ Eroare la sincronizare - verificÄƒ consola";
          errorMsg.style.display = "block";
          successMsg.style.display = "none";
        }
      }

      // ========== PRODUCTS UPLOAD (CSV MANUAL) ==========
      async function uploadProducts() {
        const file = document.getElementById("productsFile").files[0];
        const password = getAdminPassword("productsPassword");
        const successMsg = document.getElementById("uploadSuccessMsg");
        const errorMsg = document.getElementById("uploadErrorMsg");

        successMsg.style.display = "none";
        errorMsg.style.display = "none";

        if (!file) {
          errorMsg.textContent = "âŒ SelecteazÄƒ un fiÈ™ier";
          errorMsg.style.display = "block";
          return;
        }

        if (!password) {
          errorMsg.textContent = "âŒ Introdu parola";
          errorMsg.style.display = "block";
          return;
        }

        if (!file.name.endsWith(".csv")) {
          errorMsg.textContent = "âŒ Doar fiÈ™iere CSV sunt acceptate";
          errorMsg.style.display = "block";
          return;
        }

        setAdminPassword(password);

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/api/admin/upload-products", {
            method: "POST",
            headers: {
              "X-Admin-Password": password,
            },
            body: formData,
          });

          const data = await response.json();

          if (response.ok) {
            const removed = data.removed_count || 0;
            successMsg.textContent = "âœ… " + (data.message || "Produse sincronizate!");
            successMsg.style.display = "block";

            document.getElementById("totalProducts").textContent = data.products_count;
            document.getElementById("lastUpdated").textContent = new Date().toLocaleString("ro-RO");
            document.getElementById("dataSource").textContent = "CSV Manual";

            document.getElementById("productsFile").value = "";

            setTimeout(() => {
              successMsg.style.display = "none";
            }, 4000);
          } else {
            errorMsg.textContent = "âŒ " + (data.error || "Eroare la upload");
            errorMsg.style.display = "block";
          }
        } catch (error) {
          console.error("Upload error:", error);
          errorMsg.textContent = "âŒ Eroare la upload - verificÄƒ consola";
          errorMsg.style.display = "block";
        }
      }

      // ========== CHECK PRODUCTS STATUS ==========
      async function checkProductsStatus() {
        const password = getAdminPassword("productsPassword") || "admin123";
        const output = document.getElementById("statusOutput");
        output.style.display = "block";
        output.textContent = "Se verificÄƒ...";

        try {
          const response = await fetch("/api/admin/check-products?password=" + encodeURIComponent(password));
          const text = await response.text();

          console.log("Raw response:", text);

          try {
            const data = JSON.parse(text);

            if (data.error) {
              output.textContent = "âŒ Eroare: " + data.error;
              return;
            }

            let html = "âœ… FiÈ™ier existÄƒ: " + data.file_exists + "\n";
            html += "âœ… Dimensiune: " + (data.file_size || "N/A") + " bytes\n";
            html += "âœ… Produse Ã®ncÄƒrcate: " + (data.bot_products_count || 0) + "\n";
            html += "âœ… Exemple produse:\n";
            html += JSON.stringify(data.bot_products_sample || [], null, 2);

            output.textContent = html;
            
            // Update stats
            document.getElementById("totalProducts").textContent = data.bot_products_count || 0;
          } catch (jsonError) {
            console.error("JSON Parse Error:", jsonError);
            output.textContent = "âŒ JSON invalid: " + jsonError.message + "\n\nRÄƒspuns: " + text.substring(0, 200);
          }
        } catch (error) {
          console.error("Fetch Error:", error);
          output.textContent = "âŒ Eroare: " + error.message;
        }
      }

      // ========== ANALYTICS (XSS SAFE) ==========
      async function loadConversations() {
        const password = document.getElementById("analyticsPassword").value;
        const list = document.getElementById("conversationsList");

        list.innerHTML = '<div class="loading">Se Ã®ncarcÄƒ...</div>';

        try {
          const response = await fetch("/api/conversations?password=" + encodeURIComponent(password));
          const data = await response.json();

          if (data.error) {
            list.innerHTML = '<div class="no-data">âŒ ParolÄƒ greÈ™itÄƒ!</div>';
            return;
          }

          document.getElementById("totalConversations").textContent = data.length;

          if (data.length === 0) {
            list.innerHTML = '<div class="no-data">ğŸ“­ Nicio conversaÈ›ie Ã®ncÄƒ</div>';
            return;
          }

          // Clear and rebuild with XSS protection
          list.innerHTML = "";
          
          data.forEach((conv) => {
            const date = new Date(conv.timestamp).toLocaleString("ro-RO");
            
            const item = document.createElement("div");
            item.className = "conversation-item";
            
            // Time
            const timeDiv = document.createElement("div");
            timeDiv.className = "conversation-time";
            timeDiv.textContent = "â° " + date;
            
            // User message (XSS SAFE)
            const userDiv = document.createElement("div");
            userDiv.className = "conversation-user";
            const userStrong = document.createElement("strong");
            userStrong.textContent = "ğŸ‘¤ Client:";
            const userText = document.createTextNode(" " + (conv.user_message || "").substring(0, 80) + (conv.user_message && conv.user_message.length > 80 ? "..." : ""));
            userDiv.appendChild(userStrong);
            userDiv.appendChild(userText);
            
            // Bot response (XSS SAFE)
            const botDiv = document.createElement("div");
            botDiv.className = "conversation-response";
            const botStrong = document.createElement("strong");
            botStrong.textContent = "ğŸ¤– Bot:";
            const botBr = document.createElement("br");
            const botText = document.createTextNode((conv.bot_response || "").substring(0, 150) + (conv.bot_response && conv.bot_response.length > 150 ? "..." : ""));
            botDiv.appendChild(botStrong);
            botDiv.appendChild(botBr);
            botDiv.appendChild(botText);
            
            item.appendChild(timeDiv);
            item.appendChild(userDiv);
            item.appendChild(botDiv);
            list.appendChild(item);
          });
        } catch (error) {
          console.error("Error:", error);
          list.innerHTML = '<div class="no-data">âŒ Eroare la Ã®ncÄƒrcarea conversaÈ›iilor</div>';
        }
      }

      // ========== INIT ==========
      window.addEventListener("load", function () {
        loadConfig();
        loadAndDisplaySavedRules();

        fetch("/health")
          .then((r) => r.json())
          .then((data) => {
            document.getElementById("totalProducts").textContent = data.products_loaded;
          })
          .catch((e) => console.log("Health check failed:", e));
      });

      // Close modals on ESC key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeEditCustomRuleModal();
          closeEditFAQModal();
        }
      });

      // Close modals on outside click
      window.addEventListener("click", function (event) {
        if (event.target.classList.contains("modal")) {
          closeEditCustomRuleModal();
          closeEditFAQModal();
        }
      });
    </script>
  </body>
</html>
